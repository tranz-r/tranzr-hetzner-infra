#cloud-config
package_update: true
packages: [curl]

write_files:
  - path: /usr/local/bin/install-k3s.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      # get.k3s.io reads these env vars; they are passed to the child shell (sh -s -)
      export INSTALL_K3S_CHANNEL="${k3s_channel}"
      export K3S_TOKEN="${k3s_token}"
      # --tls-san and --advertise-address so API cert includes private IP; Cilium uses it (k8sServiceHost)
      export INSTALL_K3S_EXEC="server \
        --node-ip ${master_private_ip} \
        --advertise-address ${master_private_ip} \
        --tls-san ${master_private_ip} \
        --disable=traefik \
        --disable=servicelb \
        --disable=local-storage \
        --disable-cloud-controller \
        --kubelet-arg cloud-provider=external \
        --disable-kube-proxy \
        --flannel-backend=none \
        --disable-network-policy \
        --write-kubeconfig-mode 0644 \
        --cluster-cidr 10.42.0.0/16 \
        --service-cidr 10.43.0.0/16 \
        --cluster-init \
        --node-name ${node_name}"

      curl -sfL https://get.k3s.io | sh -s -

runcmd:
  - /usr/local/bin/install-k3s.sh
  - systemctl enable k3s
  - systemctl restart k3s

